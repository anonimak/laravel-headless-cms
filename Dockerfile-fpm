# Gunakan image PHP 8.3 dengan FPM sebagai dasar
FROM php:8.3-fpm

# Set environment variables (no changes needed here)
ENV APP_ENV=${APP_ENV:-production}
ENV APP_DEBUG=${APP_DEBUG:-false}
ENV APP_KEY=${APP_KEY}
ENV APP_URL=${APP_URL:-https://laravelcms.anonimak.my.id}
# Add these new environment variables for HTTPS behind proxy
ENV ASSET_URL=${APP_URL}
ENV VITE_SERVER_HTTPS=true
ENV TRUST_PROXY=true
ENV DB_CONNECTION=${DB_CONNECTION:-sqlite}
ENV DB_HOST=${DB_HOST}
ENV DB_PORT=${DB_PORT}
ENV DB_DATABASE=${DB_DATABASE:-/var/www/html/database/database.sqlite}
ENV DB_USERNAME=${DB_USERNAME}
ENV DB_PASSWORD=${DB_PASSWORD}
ENV SCOUT_DRIVER=${SCOUT_DRIVER:-collection}
ENV CACHE_DRIVER=${CACHE_DRIVER:-file}
ENV SESSION_DRIVER=${SESSION_DRIVER:-file}
ENV QUEUE_CONNECTION=${QUEUE_CONNECTION:-sync}
ENV FILESYSTEM_DISK=${FILESYSTEM_DISK:-public}
ENV REDIS_HOST=${REDIS_HOST}
ENV REDIS_PORT=${REDIS_PORT:-6379}
ENV MAIL_MAILER=${MAIL_MAILER:-log}
ENV MAIL_HOST=${MAIL_HOST}
ENV MAIL_PORT=${MAIL_PORT}
ENV MAIL_USERNAME=${MAIL_USERNAME}
ENV MAIL_PASSWORD=${MAIL_PASSWORD}

# Set working directory
WORKDIR /var/www/html

# --- Instalasi Dependensi Sistem & Ekstensi PHP ---
# Combined install for better layer caching
RUN apt-get update && apt-get install -y \
    git \
    curl \
    libpng-dev \
    libonig-dev \
    libxml2-dev \
    libzip-dev \
    zip \
    unzip \
    sqlite3 \
    libsqlite3-dev \
    nodejs \
    npm \
    nano \
    && rm -rf /var/lib/apt/lists/* \
    && docker-php-ext-install \
    pdo_mysql \
    pdo_sqlite \
    mbstring \
    exif \
    pcntl \
    bcmath \
    gd \
    zip \
    ctype \
    fileinfo

# --- Instalasi Composer ---
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer


# --- Salin Kode Aplikasi ---
COPY . .

# --- Instalasi Dependensi Aplikasi (Cache-Optimized) ---
RUN composer install --optimize-autoloader --no-dev --no-interaction --no-scripts

# --- Instalasi Dependensi Node.js dan Build Aset ---
RUN npm install && npm run build


# Set ownership
RUN chown -R www-data:www-data /var/www/html

# <-- Add this line to copy your custom config
COPY docker/php/custom-www.conf /usr/local/etc/php-fpm.d/www.conf

# Create necessary directories and set permissions
RUN mkdir -p storage/logs storage/framework/cache storage/framework/sessions storage/framework/views storage/app/public/media bootstrap/cache database \
    && touch database/database.sqlite \
    && chown -R www-data:www-data storage bootstrap/cache database \
    && chmod -R 775 storage bootstrap/cache \
    && chmod 664 database/database.sqlite

# --- Konfigurasi Entrypoint ---
COPY docker/entrypoint.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Expose port 9001 for PHP-FPM
EXPOSE 9001

# Tetapkan entrypoint dan command default
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
# <-- Changed CMD to start PHP-FPM
CMD ["php-fpm"]